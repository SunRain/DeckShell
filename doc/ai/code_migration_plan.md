# DeckShell 代码移植计划

## 项目概述

本次移植任务的目标是将 `3rdparty/waylib-shared/src-unused/` 中的完整 Treeland 合成器实现移植到 `compositor/` 目录中，以解决编译错误并完善 DeckShell 合成器的功能。

## 架构对比

### 源文件夹结构 (3rdparty/waylib-shared/src-unused/)
```
├── core/                    # 核心组件
│   ├── treeland.h/cpp      # 主控制器类
│   ├── qmlengine.h/cpp     # QML 引擎工厂
│   ├── helper.h/cpp        # 系统助手类
│   └── surface容器类
├── modules/                # 功能模块
├── plugins/                # 插件系统
├── input/                  # 输入处理
├── output/                 # 输出管理
├── surface/                # 表面管理
├── workspace/              # 工作区管理
└── utils/                  # 工具类
```

### 目标文件夹结构 (compositor/)
```
├── 主文件
│   ├── main.cpp
│   ├── CMakeLists.txt
│   └── 配置文件
├── 核心组件 (待完善)
│   ├── helper.h/cpp        # 已存在，需扩展
│   ├── qmlengine.h/cpp     # 已存在，需完善
│   └── output.h/cpp        # 已扩展
└── 子目录
    ├── surface/            # 表面管理
    ├── workspace/          # 工作区管理
    └── dde-shell/          # DDE Shell 集成
```

## 移植策略

### 1. 核心组件移植
- **Helper类**: 从369行扩展到目标的215行，添加缺失的协议支持和系统管理功能
- **QmlEngine类**: 完善QML组件工厂，添加所有动画和界面组件创建方法
- **Treeland类**: 移植主控制器，实现完整的合成器生命周期管理

### 2. 容器系统移植
- **RootSurfaceContainer**: 根表面容器，管理所有表面的层次结构
- **LayerSurfaceContainer**: 图层面容器，处理Wayland layer-shell协议
- **PopupSurfaceContainer**: 弹出表面容器，管理弹出窗口

### 3. 模块系统移植
移植所有功能模块：
- **DDE Shell集成**: 深度桌面环境集成
- **窗口管理**: 窗口生命周期和状态管理
- **输入处理**: 手势识别和输入设备管理
- **壁纸管理**: 动态壁纸和背景设置
- **快捷键**: 系统快捷键处理

### 4. 兼容性处理
- **命名空间**: 确保 `DeckShell::Compositor` 命名空间兼容性
- **API适配**: 调整API调用以匹配目标项目的接口
- **依赖管理**: 处理Qt6/Waylib版本差异

## 移植顺序

按照依赖关系进行有序移植：

1. **基础工具类** → 2. **核心组件** → 3. **容器系统** → 4. **功能模块** → 5. **插件系统**

## 质量保证

### 编译验证
- 每个移植步骤后进行编译测试
- 使用多线程编译加速验证过程
- 记录并修复所有编译错误

### 功能验证
- 验证移植后的功能完整性
- 确保与现有代码的兼容性
- 进行回归测试

## 风险控制

### 主要风险
1. **API冲突**: 源代码与目标代码的API不兼容
2. **依赖缺失**: 源代码依赖的库在目标环境中不存在
3. **命名冲突**: 类名、函数名冲突导致编译错误

### 缓解措施
1. **增量移植**: 分步骤进行，便于问题定位
2. **备份机制**: 保留原始文件作为备份
3. **文档记录**: 详细记录每次修改的原因和影响

## 成功标准

- 项目能够成功编译，无错误
- 所有原有功能保持正常工作
- 新移植的功能能够正常使用
- 代码结构清晰，易于维护